{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Nginx front end instance",

  "Parameters": {
    "vpcId": {
      "Type": "AWS::EC2::VPC::Id"
    },
    "bucketName": {
      "Type": "String"
    },
    "roleName": {
      "Type": "String"
    },
    "iamInstanceProfile": {
      "Type": "String"
    },
    "keyName": {
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "availabilityZone": {
      "Type": "String"
    },
    "subnetId": {
      "Type": "AWS::EC2::Subnet::Id"
    },
    "privateIpAddress": {
      "Type": "String"
    },
    "publicIpAddress": {
      "Type": "String"
    }
  },

  "Mappings": {
  },

  "Conditions": {
  },

  "Resources": {

    "nginxFrontEndSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "enable SSH and HTTP incoming and anything outgoing",
        "VpcId": { "Ref": "vpcId" },
        "SecurityGroupIngress": [{
          "IpProtocol": "tcp",
          "FromPort": "22",
          "ToPort": "22",
          "CidrIp": "0.0.0.0/0"
        }, {
          "IpProtocol": "tcp",
          "FromPort": "80",
          "ToPort": "80",
          "CidrIp": "0.0.0.0/0"
        }],
        "SecurityGroupEgress": [{
          "IpProtocol": "-1",
          "FromPort": "0",
          "ToPort": "65535",
          "CidrIp": "0.0.0.0/0"
        }]
      }
    },

    "launchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Metadata": {
        "AWS::CloudFormation::Init": {
          "configSets": {
            "configSet": [ "updateApt", "installEc2Tools", "assignIps", "runChef" ]
          },
          "updateApt": {
            "commands": {
              "updateApt": "apt-get update"
            }
          },
          "installEc2Tools": {
            "commands": {
              "installEc2Tools": "apt-get install ec2-api-tools"
            }
          },
          "assignIps": {
            "files": {
              "/root/assign-ips.sh": {
                "content": { "Fn::Join": [ "", [
                  "#!/bin/bash -e", "\n",
                  "securityCredentials=`wget -q -O - http://169.254.169.254/latest/meta-data/iam/security-credentials/", { "Ref": "roleName" }, "`", "\n",
                  "AWS_ACCESS_KEY=`echo $securityCredentials | sed -n 's/.*\"AccessKeyId\"\\s*:\\s*\"\\([^\"]*\\)\".*/\\1/p'`", "\n",
                  "AWS_SECRET_KEY=`echo $securityCredentials | sed -n 's/.*\"SecretAccessKey\"\\s*:\\s*\"\\([^\"]*\\)\".*/\\1/p'`", "\n",
                  "instanceid=`wget -q -O - http://169.254.169.254/latest/meta-data/instance-id`", "\n",
                  "ec2-associate-address ", { "Ref": "publicIpAddress" }, " -i $instanceid", "\n"
                ]]},
                "mode": "000700",
                "owner": "root",
                "group": "root"
              }
            },
            "commands": {
              "assignIps": {
                "command": "/root/assign-ips.sh"
              }
            }
          },
          "runChef": {
            "files": {
              "/tmp/NginxFrontEnd.tar.gz": {
                "source": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/cookbooks/NginxFrontEnd.tar.gz" ] ] },
                "Authentication": "s3",
                "mode": "000644",
                "owner": "root",
                "group": "root"
              }
            },
            "commands": {
              "001_InstallChef": {
                "command": "wget -O - https://www.opscode.com/chef/install.sh | sh",
                "test": "! which chef-client"
              },
              "002_UnpackCookbooks": {
                "command": "rm -rf cookbooks && tar zxf NginxFrontEnd.tar.gz",
                "cwd": "/tmp"
              },
              "003_RunChef": {
                "command": "chef-client -z -r NginxFrontEnd",
                "cwd": "/tmp"
              }
            }
          }
        },
        "AWS::CloudFormation::Authentication": {
          "s3": {
            "type": "S3",
            "buckets": [ { "Ref": "bucketName" } ],
            "roleName": { "Ref": "roleName" }
          }
        }
      },
      "Properties": {
        "ImageId": "ami-9a562df2",
        "InstanceType": "t2.micro",
        "KeyName": { "Ref": "keyName" },
        "SecurityGroups": [
          { "Ref": "nginxFrontEndSecurityGroup" }
        ],
        "IamInstanceProfile": { "Ref": "iamInstanceProfile" },
        "UserData": { "Fn::Base64": { "Fn::Join": ["", [
          "#!/bin/bash -ex", "\n",
          "apt-get update", "\n",
          "apt-get -y install python-setuptools", "\n",
          "wget -P /root https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
          "mkdir -p /root/aws-cfn-bootstrap-latest", "\n",
          "tar xvfz /root/aws-cfn-bootstrap-latest.tar.gz --strip-components=1 -C /root/aws-cfn-bootstrap-latest", "\n",
          "easy_install /root/aws-cfn-bootstrap-latest/", "\n",
          "/usr/local/bin/cfn-init -s ", { "Ref": "AWS::StackName" },
          "  -r launchConfiguration",
          "  -c configSet",
          "  --region ", { "Ref": "AWS::Region" }, "\n"
        ]]}}
      }
    },

    "autoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AvailabilityZones": [ { "Ref": "availabilityZone" } ],
        "LaunchConfigurationName": { "Ref": "launchConfiguration" },
        "VPCZoneIdentifier": [ { "Ref": "subnetId" } ],
        "Cooldown": "10",
        "MaxSize": "1",
        "MinSize": "1"
      }
    }

  },

  "Outputs": {
  }
}
