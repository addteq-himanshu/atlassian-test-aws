{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Nginx front end instance",

  "Parameters": {
    "vpcId": {
      "Type": "AWS::EC2::VPC::Id"
    },
    "eipAllocationId": {
      "Type": "String"
    },
    "stackId": {
      "Type": "String"
    }
  },

  "Mappings": {
  },

  "Conditions": {
  },

  "Resources": {

    "securityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "enable SSH and HTTP incoming and anything outgoing",
        "VpcId": { "Ref": "vpcId" },
        "SecurityGroupIngress": [{
          "IpProtocol": "tcp",
          "FromPort": "22",
          "ToPort": "22",
          "CidrIp": "0.0.0.0/0"
        }, {
          "IpProtocol": "tcp",
          "FromPort": "80",
          "ToPort": "80",
          "CidrIp": "0.0.0.0/0"
        }],
        "SecurityGroupEgress": [{
          "IpProtocol": "-1",
          "FromPort": "0",
          "ToPort": "65535",
          "CidrIp": "0.0.0.0/0"
        }]
      }
    },

    "layer": {
      "Type": "AWS::OpsWorks::Layer",
      "Properties": {
        "AutoAssignElasticIps": false,
        "AutoAssignPublicIps": false,
        "CustomRecipes": {
          "Setup": [ "nginxFrontEnd::default" ]
        },
        "CustomSecurityGroupIds": [ { "Ref": "securityGroup" } ],
        "EnableAutoHealing": true,
        "InstallUpdatesOnBoot": true,
        "Name": "nginxFrontEnd",
        "Shortname": "nginx",
        "StackId": { "Ref": "stackId" },
        "Type": "custom"
      }
    },

    "instance": {
      "Type": "AWS::OpsWorks::Instance",
      "Properties": {
        "InstanceType": "t2.micro",
        "LayerIds": [ { "Ref": "layer" } ],
        "StackId": { "Ref": "stackId" }
      }
    },

    "eipAssociation": {
      "Type": "AWS::EC2::EIPAssociation",
      "Properties": {
        "AllocationId": { "Ref": "eipAllocationId" },
        "InstanceId": { "Ref": "instance" }
      }
    }

  },

  "Outputs": {
  }
}
