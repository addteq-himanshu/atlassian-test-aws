{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Nginx front end instance",

  "Parameters": {
    "vpcId": {
      "Type": "AWS::EC2::VPC::Id"
    },
    "subnetId": {
      "Type": "AWS::EC2::Subnet::Id"
    },
    "domain": {
      "Type": "String"
    },
    "proxyPort": {
      "Type": "Number"
    },
    "crowdSubDomain": {
      "Type": "String"
    },
    "jiraSubDomain": {
      "Type": "String"
    },
    "confluenceSubDomain": {
      "Type": "String"
    },
    "stashSubDomain": {
      "Type": "String"
    },
    "bambooSubDomain": {
      "Type": "String"
    },
    "stackId": {
      "Type": "String"
    }
  },

  "Mappings": {
  },

  "Conditions": {
  },

  "Resources": {

    "securityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Port for the load balancer",
        "SecurityGroupIngress": {
          "CidrIp": "0.0.0.0/0",
          "FromPort": { "Ref": "proxyPort" },
          "IpProtocol": "tcp",
          "ToPort": { "Ref": "proxyPort" }
        },
        "VpcId": { "Ref": "vpcId" }
      }
    },

    "layer": {
      "Type": "AWS::OpsWorks::Layer",
      "Properties": {
        "AutoAssignElasticIps": false,
        "AutoAssignPublicIps": true,
        "CustomRecipes": {
          "Setup": [ "reverse-proxy::setup" ],
          "Configure": [ "reverse-proxy::configure" ]
        },
        "EnableAutoHealing": true,
        "InstallUpdatesOnBoot": true,
        "Name": "nginx",
        "Shortname": "nginx",
        "StackId": { "Ref": "stackId" },
        "Type": "custom"
      }
    },

    "loadBalancer" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "Subnets" : [ { "Ref": "subnetId" } ],
        "Listeners" : [{
          "LoadBalancerPort" : { "Ref": "proxyPort" },
          "InstancePort" : { "Ref": "proxyPort" },
          "Protocol" : "HTTP"
        }],
        "SecurityGroups": [ { "Ref": "securityGroup" } ]
      }
    },

    "elasticLoadBalancerAttachment": {
      "Type": "AWS::OpsWorks::ElasticLoadBalancerAttachment",
      "Properties": {
        "ElasticLoadBalancerName" : { "Ref": "loadBalancer" },
        "LayerId" : { "Ref": "layer" }
      }
    },

    "recordSetGroup" : {
      "Type": "AWS::Route53::RecordSetGroup",
      "Properties": {
        "HostedZoneName": { "Fn::Join": [ "", [ { "Ref": "domain" }, "." ] ] },
        "RecordSets": [{
          "Name": { "Fn::Join": [ "", [ { "Ref": "crowdSubDomain" }, ".", { "Ref": "domain" }, "." ] ] },
          "Type": "A",
          "AliasTarget": {
            "HostedZoneId": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneNameID" ] },
            "DNSName": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneName" ] }
          }
        }, {
          "Name": { "Fn::Join": [ "", [ { "Ref": "jiraSubDomain" }, ".", { "Ref": "domain" }, "." ] ] },
          "Type": "A",
          "AliasTarget": {
            "HostedZoneId": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneNameID" ] },
            "DNSName": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneName" ] }
          }
        }, {
          "Name": { "Fn::Join": [ "", [ { "Ref": "confluenceSubDomain" }, ".", { "Ref": "domain" }, "." ] ] },
          "Type": "A",
          "AliasTarget": {
            "HostedZoneId": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneNameID" ] },
            "DNSName": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneName" ] }
          }
        }, {
          "Name": { "Fn::Join": [ "", [ { "Ref": "stashSubDomain" }, ".", { "Ref": "domain" }, "." ] ] },
          "Type": "A",
          "AliasTarget": {
            "HostedZoneId": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneNameID" ] },
            "DNSName": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneName" ] }
          }
        }, {
          "Name": { "Fn::Join": [ "", [ { "Ref": "bambooSubDomain" }, ".", { "Ref": "domain" }, "." ] ] },
          "Type": "A",
          "AliasTarget": {
            "HostedZoneId": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneNameID" ] },
            "DNSName": { "Fn::GetAtt" : [ "loadBalancer", "CanonicalHostedZoneName" ] }
          }
        }]
      }
    },

    "instance": {
      "Type": "AWS::OpsWorks::Instance",
      "Properties": {
        "InstanceType": "t2.micro",
        "LayerIds": [ { "Ref": "layer" } ],
        "StackId": { "Ref": "stackId" }
      }
    }

  },

  "Outputs": {
  }
}
