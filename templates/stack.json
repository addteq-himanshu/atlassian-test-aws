{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "OpsWorks stack containing all instances",

  "Parameters": {
    "vpcId": {
      "Type": "AWS::EC2::VPC::Id"
    },
    "bucketName": {
      "Type": "String"
    },
    "keyName": {
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "availabilityZone": {
      "Type": "String"
    },
    "subnetId": {
      "Type": "AWS::EC2::Subnet::Id"
    },
    "domain": {
      "Type": "String"
    },
    "crowdSubDomain": {
      "Type": "String"
    },
    "crowdPort": {
      "Type": "String"
    },
    "jiraSubDomain": {
      "Type": "String"
    },
    "jiraPort": {
      "Type": "String"
    },
    "confluenceSubDomain": {
      "Type": "String"
    },
    "confluencePort": {
      "Type": "String"
    },
    "stashSubDomain": {
      "Type": "String"
    },
    "stashPort": {
      "Type": "String"
    },
    "bambooSubDomain": {
      "Type": "String"
    },
    "bambooPort": {
      "Type": "String"
    },
    "s3AccessKeyId": {
      "Type": "String"
    },
    "s3SecretAccessKey": {
      "Type": "String"
    },
    "dbEndpointAddress": {
      "Type": "String"
    },
    "dbEndpointPort": {
      "Type": "Number"
    }
  },

  "Mappings": {
  },

  "Conditions": {
  },

  "Resources": {

    "stack": {
      "Type": "AWS::OpsWorks::Stack",
      "Properties": {
        "ConfigurationManager": {
          "Name": "Chef",
          "Version": "11.10"
        },
        "CustomCookbooksSource": {
          "Password": { "Ref": "s3SecretAccessKey" },
          "Username": { "Ref": "s3AccessKeyId" },
          "Type": "s3",
          "Url": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/cookbooks.tar.gz" ] ] }
        },
        "CustomJson": {
          "atlassian-test": {
            "database": {
              "address": { "Ref": "dbEndpointAddress" },
              "port": { "Ref": "dbEndpointPort" }
            }, 
            "crowd": {
              "host": { "Fn::Join": [ "", [ { "Ref": "crowdSubDomain" }, ".", { "Ref": "domain" } ] ] },
              "port": { "Ref": "crowdPort" }
            },
            "jira": {
              "host": { "Fn::Join": [ "", [ { "Ref": "jiraSubDomain" }, ".", { "Ref": "domain" } ] ] },
              "port": { "Ref": "jiraPort" }
            },
            "confluence": {
              "host": { "Fn::Join": [ "", [ { "Ref": "confluenceSubDomain" }, ".", { "Ref": "domain" } ] ] },
              "port": { "Ref": "confluencePort" }
            },
            "stash": {
              "host": { "Fn::Join": [ "", [ { "Ref": "stashSubDomain" }, ".", { "Ref": "domain" } ] ] },
              "port": { "Ref": "stashPort" }
            },
            "bamboo": {
              "host": { "Fn::Join": [ "", [ { "Ref": "bambooSubDomain" }, ".", { "Ref": "domain" } ] ] },
              "port": { "Ref": "bambooPort" }
            }
          }
        },
        "ServiceRoleArn" : { "Fn::Join": ["", ["arn:aws:iam::", {"Ref":"AWS::AccountId"}, ":role/aws-opsworks-service-role"]] },
        "DefaultInstanceProfileArn" : { "Fn::Join": ["", ["arn:aws:iam::", {"Ref":"AWS::AccountId"}, ":instance-profile/aws-opsworks-ec2-role"]] },
        "DefaultAvailabilityZone": { "Ref": "availabilityZone" },
        "DefaultOs": "Ubuntu 14.04 LTS",
        "DefaultRootDeviceType": "ebs",
        "DefaultSshKeyName": { "Ref": "keyName" },
        "DefaultSubnetId": { "Ref": "subnetId" },
        "HostnameTheme": "Baked_Goods",
        "Name": "atlassian-test",
        "UseCustomCookbooks": true,
        "UseOpsworksSecurityGroups": true,
        "VpcId": { "Ref": "vpcId" }
      }
    }

  },

  "Outputs": {
    "stackId": {
      "Value": { "Ref": "stack" }
    }
  }
}
