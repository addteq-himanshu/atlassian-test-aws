{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Test Atlassian deployment including:\r\n\r\nNginx front end\r\nCrowd\r\nJIRA\r\nConfluence\r\nStash\r\nBamboo\r\nPostgres RDS DB",

  "Parameters": {
    "bucketName": {
      "Type": "String"
    },
    "availabilityZone1": {
      "Type": "String"
    },
    "availabilityZone2": {
      "Type": "String"
    },
    "keyName": {
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "dbUsername": {
      "Type": "String"
    },
    "dbPassword": {
      "Type": "String"
    },
    "domain": {
      "Type": "String"
    },
    "crowdSubDomain": {
      "Type": "String",
      "Default": "crowd"
    },
    "crowdPort": {
      "Type": "Number",
      "Default": "8095"
    },
    "jiraSubDomain": {
      "Type": "String",
      "Default": "jira"
    },
    "jiraPort": {
      "Type": "Number",
      "Default": "8080"
    },
    "confluenceSubDomain": {
      "Type": "String",
      "Default": "confluence"
    },
    "confluencePort": {
      "Type": "Number",
      "Default": "8090"
    },
    "stashSubDomain": {
      "Type": "String",
      "Default": "stash"
    },
    "stashPort": {
      "Type": "Number",
      "Default": "7990"
    },
    "bambooSubDomain": {
      "Type": "String",
      "Default": "bamboo"
    },
    "bambooPort": {
      "Type": "Number",
      "Default": "8085"
    }
  },

  "Mappings": {
  },

  "Conditions": {
  },

  "Resources": {

    "vpc": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/templates/vpc.json" ] ] },
        "Parameters": {
          "cidrBlock": "10.0.0.0/16",
          "subnet1CidrBlock": "10.0.0.0/24",
          "subnet1AvailabilityZone": { "Ref": "availabilityZone1" },
          "subnet2CidrBlock": "10.0.1.0/24",
          "subnet2AvailabilityZone": { "Ref": "availabilityZone2" }
        }
      }
    },

    "rds": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/templates/rds.json" ] ] },
        "Parameters": {
          "subnet1Id": { "Fn::GetAtt": [ "vpc", "Outputs.subnet1Id" ] },
          "subnet2Id": { "Fn::GetAtt": [ "vpc", "Outputs.subnet2Id" ] },
          "username": { "Ref": "dbUsername" },
          "password": { "Ref": "dbPassword" }
        }
      }
    },

    "s3User": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/templates/s3-user.json" ] ] },
        "Parameters": {
          "bucketName": { "Ref": "bucketName" }
        }
      }
    },

    "stack": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/templates/stack.json" ] ] },
        "Parameters": {
          "vpcId": { "Fn::GetAtt": [ "vpc", "Outputs.vpcId" ] },
          "bucketName": { "Ref": "bucketName" },
          "keyName": { "Ref": "keyName" },
          "availabilityZone": { "Ref": "availabilityZone1" },
          "subnetId": { "Fn::GetAtt": [ "vpc", "Outputs.subnet1Id" ] },
          "domain": { "Ref": "domain" },
          "crowdSubDomain" : { "Ref": "crowdSubDomain" },
          "crowdPort": { "Ref": "crowdPort" },
          "jiraSubDomain" : { "Ref": "jiraSubDomain" },
          "jiraPort": { "Ref": "jiraPort" },
          "confluenceSubDomain" : { "Ref": "confluenceSubDomain" },
          "confluencePort": { "Ref": "confluencePort" },
          "stashSubDomain" : { "Ref": "stashSubDomain" },
          "stashPort": { "Ref": "stashPort" },
          "bambooSubDomain" : { "Ref": "bambooSubDomain" },
          "bambooPort": { "Ref": "bambooPort" },
          "dbEndpointAddress": { "Fn::GetAtt": [ "rds", "Outputs.endpointAddress" ] },
          "dbEndpointPort": { "Fn::GetAtt": [ "rds", "Outputs.endpointPort" ] },
          "s3AccessKeyId": { "Fn::GetAtt": [ "s3User", "Outputs.accessKeyId" ] },
          "s3SecretAccessKey": { "Fn::GetAtt": [ "s3User", "Outputs.secretAccessKey" ] }
        }
      }
    },

    "reverseProxy": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/templates/reverse-proxy.json" ] ] },
        "Parameters": {
          "vpcId": { "Fn::GetAtt": [ "vpc", "Outputs.vpcId" ] },
          "subnetId": { "Fn::GetAtt": [ "vpc", "Outputs.subnet1Id" ] },
          "domain": { "Ref": "domain" },
          "crowdSubDomain" : { "Ref": "crowdSubDomain" },
          "jiraSubDomain" : { "Ref": "jiraSubDomain" },
          "confluenceSubDomain" : { "Ref": "confluenceSubDomain" },
          "stashSubDomain" : { "Ref": "stashSubDomain" },
          "bambooSubDomain" : { "Ref": "bambooSubDomain" },
          "stackId": { "Fn::GetAtt": [ "stack", "Outputs.stackId" ] }
        }
      }
    },

    "crowd": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": { "Fn::Join": [ "", [ "https://s3.amazonaws.com/", { "Ref": "bucketName" }, "/templates/crowd.json" ] ] },
        "Parameters": {
          "stackId": { "Fn::GetAtt": [ "stack", "Outputs.stackId" ] }
        }
      }
    }

  },

  "Outputs": {
  }
}
